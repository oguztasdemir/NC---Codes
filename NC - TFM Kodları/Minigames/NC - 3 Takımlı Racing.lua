translations = {
en = {
redwon = "The <font color='#CB546B'><b>red team</b></font> won!",
greenwon = "The <font color='#30BA76'><b>green team</b></font> won!",
bluewon = "The <font color='#2E72CB'><b>blue team</b></font> won!",
pKey = "You have to use the 'P' key to express your wish to enter into a pact with your preys.",
pact = "You can no longer kill during 20 seconds. Cooperate with your preys!",
noKillDuring = "You can no longer kill during ",
cooperate = " seconds. Cooperate with your preys!",
canKill = "You can now kill your prey or continue to cooperate.",
h = "Help",
p = "Pact",
killGreen = "Kill the mice of the <font color='#30BA76'><b>green team</b></font> with the space bar and collect the bonuses with the 'B' key.",
killBlue = "Kill the mice of the <font color='#2E72CB'><b>blue team</b></font> with the space bar and collect the bonuses with the 'B' key.",
killRed = "Kill the mice of the <font color='#CB546B'><b>red team</b></font> with the space bar and collect the bonuses with the 'B' key.",
helpWindow = "<p align='center'><font size='26' face='Chizz'>The Hunter</font>" ..
"<br /><font size='8'>Are you the predator or the prey?</font></p>" ..
"<br /><br /><font size='9'>Three teams compete to determine who are the predators and the preys!" ..
"<br />The winning team will be the one designated as predatory team." ..
"<br /><br />The couples hunters/hunted work as the types (fire, plant, water) in Pokemon!<br />" ..
"<br />The <font color='#CB546B'>red team</font> attacks the <font color='#30BA76'>green team</font>." ..
"<br />The <font color='#30BA76'>green team</font> attacks the <font color='#2E72CB'>blue team</font>." ..
"<br />The <font color='#2E72CB'>blue team</font> attacks the <font color='#CB546B'>red team</font>." ..
"<br /><br /><b>Space bar:</b>" ..
"<br />Attack and kill the preys close to you." ..
"<br /><br /><b>'P' key:</b>" ..
"<br />Disable the space bar during 20 seconds. You can enter into a pact with your preys and persuade them to help you." ..
"<br /><br /><b>The gift:</b>" ..
"<br>You get a random bonus by pressing the 'B' key if you are close to the gift." ..
"<br /><br /><font size='6' color='#BABD2F'>Module '<b>The Hunter</b>' developed by Animjarcanin. Please report the bugs and suggestions. Have fun!</font></font>",
err = "<p align='center'><font color='#BABD2F'>There aren't enough players to start the game!</font></p>",
kill = "You have killed ",
death = "You have been killed by ",
invincible = "You are <b>invincible</b> during 15 seconds.",
explosion = "You have received the <b>Explosion</b> bonus. Press the B key to use it.",
propulsion = "You have received the <b>Propulsion</b> bonus. Press the B key to use it.",
bigJump = "You have received the <b>Big Jump</b> bonus. Press the B key to use it.",
yellow = "Your nickname will be <b>yellow</b> during 20 seconds.",
rubberPact = "You have received the <b>Rubber Pact</b> bonus. Press the B key to use it.",
bonusUsed = "You just used your bonus!"
},
fr = {
redwon = "L'<font color='#CB546B'><b>équipe rouge</b></font> gagne !",
greenwon = "L'<font color='#30BA76'><b>équipe verte</b></font> gagne !",
bluewon = "L'<font color='#2E72CB'><b>équipe bleue</b></font> gagne !",
pKey = "Vous devez utiliser la touche 'P' pour exprimer votre souhait de conclure un pacte avec vos proies.",
pact = "Vous ne pouvez plus tuer pendant 20 secondes. Coopérez avec vos proies.",
noKillDuring = "Vous ne pouvez plus tuer pendant ",
cooperate = " secondes. Coopérez avec vos proies.",
canKill = "Vous pouvez désormais tuer vos proies ou bien continuez à coopérer.",
h = "Aide",
p = "Pacte",
killGreen = "Tuez les souris de l'<font color='#30BA76'><b>équipe verte</b></font> avec la barre d'espace et collecter les bonus avec la touche 'B'.",
killBlue = "Tuez les souris de l'<font color='#2E72CB'><b>équipe bleue</b></font> avec la barre d'espace et collecter les bonus avec la touche 'B'.",
killRed = "Tuez les souris de l'<font color='#CB546B'><b>équipe rouge</b></font> avec la barre d'espace et collecter les bonus avec la touche 'B'.",
helpWindow = "<p align='center'><font size='26' face='Chizz'>The Hunter</font>" ..
"<br /><font size='8'>Êtes-vous la proie ou le prédateur ?</font></p>" ..
"<br /><br /><font size='9'>Trois équipes s'affrontent pour déterminer qui sont les proies et les prédateurs !" ..
"<br />L'équipe gagnante sera celle désignée comme étant l'équipe prédatrice." ..
"<br /><br />Les couples chasseurs/chassés fonctionnent comme les types (feu, plante, eau) dans Pokémon !<br />" ..
"<br />L'<font color='#CB546B'>équipe rouge</font> attaque l'<font color='#30BA76'>équipe verte</font>." ..
"<br />L'<font color='#30BA76'>équipe verte</font> attaque l'<font color='#2E72CB'>équipe bleue</font>." ..
"<br />L'<font color='#2E72CB'>équipe bleue</font> attaque l'<font color='#CB546B'>équipe rouge</font>." ..
"<br /><br /><b>Barre d'espace :</b>" ..
"<br />Attaque et tue les proies proches de vous." ..
"<br /><br /><b>Touche 'P' :</b>" ..
"<br />Désactive la touche espace pendant 20 secondes. Pactisez avec vos proies et persuadez-les de vous aider." ..
"<br /><br /><b>Le cadeau :</b>" ..
"<br>Vous récupérez un bonus en pressant la touche 'B' si vous êtes à proximité d'un cadeau." ..
"<br /><br /><font size='6' color='#BABD2F'>Module <b>The Hunter</b> développé par Animjarcanin. Merci de reporter les bugs et vos suggestions. Amusez-vous bien !</font></font>",
err = "<p align='center'><font color='#BABD2F'>Il n'y a pas assez de joueurs pour commencer la partie !</font></p>",
kill = "Vous avez tué ",
death = "Vous avez été tué par ",
invincible = "Vous êtes <b>invincible</b> pendant 15 secondes.",
explosion = "Vous avez reçu le bonus <b>Explosion</b>. Pressez la touche B pour l'utiliser.",
propulsion = "Vous avez reçu le bonus <b>Propulsion</b>. Pressez la touche B pour l'utiliser.",
bigJump = "Vous avez reçu le bonus <b>Grand Saut</b>. Pressez la touche B pour l'utiliser.",
yellow = "Votre pseudo sera <b>jaune</b> durant 20 secondes.",
rubberPact = "Vous avez reçu le bonus <b>Pacte en Bois</b>. Pressez la touche B pour l'utiliser.",
bonusUsed = "Vous venez d'utiliser votre bonus."
}
}

-- Fonction retournant la traduction d'un message
function trans(msg, comm)
-- selon la communauté du salon
if comm == nil then
if translations[tfm.get.room.community] and translations[tfm.get.room.community][msg] then
return translations[tfm.get.room.community][msg]
else
return translations.en[msg]
end
-- selon la communauté du joueur
else
if translations[comm] and translations[comm][msg] then
return translations[comm][msg]
else
return translations.en[msg]
end
end
end

--Envoie d'un message à un joueur
function sendMessage(playerName, message)
if playerName ~= nil then
if getPlayer(playerName) ~= nil then
ui.addTextArea(10+getPlayer(playerName).id, "<font color='#CB546B'>> " .. message .. "</font>", playerName, 120, 380, 680, 20, 0x000000, 0x000000, 0, true)
end
else
for name in pairs(tfm.get.room.playerList) do
if getPlayer(name) ~= nil then
ui.addTextArea(10+getPlayer(name).id, "<font color='#CB546B'>> " .. message .. "</font>", name, 120, 380, 680, 20, 0x000000, 0x000000, 0, true)
end
end
end
end

-----------------------------------
-- ÉLÉMENTS DIVERS SUR LE MODULE --
-----------------------------------

-- Informations sur le module
local info = {
name = "The Hunter",
version = "1.0",
author = "Animjarcanin"
}

-- Si le module est lancé
started = false

-- Désactivation de certaines fonctions
tfm.exec.disableAutoNewGame(true)
tfm.exec.disableAutoShaman(true)
tfm.exec.disableAfkDeath(true)
tfm.exec.disableAutoScore(true)
for playerName in pairs(tfm.get.room.playerList) do
tfm.exec.setPlayerScore(playerName, 0, false)
end

-- Les équipes
red = {}
blue = {}
green = {}

-- Les joueurs
players = {}

-- Liste des cartes | syntaxe = xRed, yRed, xGreen, yGreen, xBlue, yBlue, xBonus, yBonus
cartes = {}

cartes[1] = {}
cartes[1].xml = [[<C><P F="0" L="1200" /><Z><S><S L="45" X="1148" H="305" Y="203" T="9" P="0,0,,,,0,0,0" /><S L="45" H="250" X="63" Y="230" T="9" P="0,0,,,,0,0,0" /><S X="200" L="40" H="50" c="1" Y="360" T="6" P="0,0,0.3,0.2,40,0,0,0" /><S L="40" H="100" X="20" Y="350" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="40" H="100" X="1180" N="" Y="350" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="200" H="40" X="100" Y="380" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="50" H="260" X="494" Y="273" T="9" P="0,0,,,,0,0,0" /><S P="0,0,0.3,0.2,-40,0,0,0" L="40" X="1000" c="1" Y="360" T="6" H="50" /><S H="50" L="40" X="500" c="1" N="" Y="150" T="6" P="0,0,0.3,0.2,-40,0,0,0" /><S P="0,0,0.3,0.2,40,0,0,0" L="40" X="700" c="1" N="" Y="150" T="6" H="50" /><S L="200" X="600" H="40" N="" Y="170" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="160" H="36" X="600" Y="400" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="160" X="600" H="36" Y="275" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="40" H="40" X="106" Y="125" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" X="186" H="40" Y="125" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" H="40" X="266" Y="125" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" X="306" H="40" Y="85" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" X="975" H="40" Y="125" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" H="40" X="900" Y="380" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" X="800" H="40" Y="380" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" H="40" X="400" Y="380" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" X="300" H="40" Y="380" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="80" X="1076" H="40" Y="125" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" H="40" X="895" Y="165" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" X="800" H="40" Y="203" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="40" H="40" X="400" Y="283" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="10" H="40" X="1195" Y="30" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="20" H="10" X="1180" Y="5" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="20" X="1180" H="10" Y="55" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="10" H="40" X="1185" Y="29" T="3" P="0,0,0,20,0,0,0,0" /><S L="10" X="5" H="40" Y="30" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="20" H="10" X="20" Y="5" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="20" H="10" X="20" Y="55" T="10" P="0,0,0.3,0,0,0,0,0" /><S L="10" H="40" X="15" Y="30" T="4" P="0,0,20,0.2,0,0,0,0" /><S L="200" H="40" X="1100" N="" Y="380" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="10" H="40" X="981" Y="338" T="2" P="0,0,0,1.2,50,0,0,0" /><S L="10" X="219" H="40" Y="337" T="2" P="0,0,0,1.2,-50,0,0,0" /></S><D><P P="0,0" Y="367" T="78" X="41" /><P P="0,0" Y="372" T="87" X="1156" /><P C="ff" Y="395" T="104" P="0,0" X="100" /><P C="ff0000" Y="185" T="104" X="600" P="0,0" /><P C="ff00" Y="395" T="104" P="0,0" X="1100" /><DS Y="0" X="0" /><P X="600" Y="380" T="62" P="0,0" /><P X="677" Y="410" T="5" P="0,0" /><P X="476" Y="139" T="2" P="0,1" /><P X="1018" Y="364" T="0" P="0,0" /><P X="15" Y="300" T="3" P="0,0" /><P P="0,0" Y="143" T="88" X="704" /><P P="0,0" Y="259" T="4" X="652" /></D><O /></Z></C>]]
cartes[1].name = "[1] - Animjarcanin"
cartes[1].info = "600,130,1100,340,100,340,600,380"

cartes[2] = {}
cartes[2].xml = [[<C><P F="0" L="1200" /><Z><S><S L="20" o="324650" H="50" X="640" Y="170" T="12" P="0,0,0.3,0.2,0,0,0,0" /><S P="0,0,0.3,0.2,0,0,0,0" L="20" o="324650" X="560" Y="170" T="12" H="50" /><S P="0,0,0.3,0.2,0,0,0,0" L="20" o="324650" X="660" Y="270" T="12" H="150" /><S L="20" o="324650" X="540" H="150" Y="270" T="12" P="0,0,0.3,0.2,0,0,0,0" /><S L="60" H="50" X="600" Y="170" T="9" P="0,0,,,,0,0,0" /><S L="100" H="150" X="600" Y="270" T="9" P="0,0,,,,0,0,0" /><S L="400" o="324650" H="20" X="600" Y="390" T="12" P="0,0,0.3,0.2,0,0,0,0" /><S P="0,0,0.3,0.2,0,0,0,0" L="200" o="550000" X="600" Y="100" T="12" H="20" /><S L="150" o="324650" H="20" X="775" Y="100" T="12" P="0,0,0.3,0.2,0,0,0,0" /><S P="0,0,0.3,0.2,0,0,0,0" L="150" o="324650" X="425" Y="100" T="12" H="20" /><S L="20" o="550055" H="20" X="860" Y="390" T="12" P="0,0,0.3,1,0,0,0,0" /><S P="0,0,0.3,1,0,0,0,0" L="20" o="550055" X="340" Y="390" T="12" H="20" /><S L="200" o="5500" X="970" H="20" Y="390" T="12" P="0,0,0.3,0.2,0,0,0,0" /><S P="0,0,0.3,0.2,0,0,0,0" L="200" o="55" H="20" Y="390" T="12" X="230" /><S P="0,0,0.3,5,0,0,0,0" L="20" o="550055" X="1080" Y="370" T="12" H="20" /><S L="20" o="324650" H="20" X="1080" Y="350" T="12" P="0,0,0.3,0.2,0,0,0,0" /><S L="20" o="550055" X="117" H="20" Y="381" T="12" P="0,0,0.3,5,45,0,0,0" /><S P="0,0,0.3,5,0,0,0,0" L="27" o="550055" H="20" Y="390" T="12" X="117" /><S P="0,0,0.3,0.2,90,0,0,0" L="20" o="324650" X="695" Y="205" T="12" H="50" /><S L="20" o="324650" X="505" H="50" Y="205" T="12" P="0,0,0.3,0.2,90,0,0,0" /></S><D><P P="0,0" Y="200" T="62" X="600" /></D><O /></Z></C>]]
cartes[2].name = "[2] - Animjarcanin"
cartes[2].info = "600,75,970,365,230,365,600,200"

cartes[3] = {}
cartes[3].xml = [[<C><P F="5" /><Z><S><S L="150" H="30" X="100" Y="150" T="11" P="0,0,0.05,0.1,0,0,0,0" /><S L="150" X="450" H="30" Y="350" T="11" P="0,0,0.05,0.1,0,0,0,0" /><S L="150" H="30" X="700" Y="200" T="11" P="0,0,0.05,0.1,0,0,0,0" /><S L="800" H="10" X="400" Y="400" T="1" P="0,0,0,0.2,0,0,0,0" /><S L="10" H="60" X="20" Y="135" T="2" P="0,0,0,2,0,0,0,0" /><S L="10" X="555" H="60" Y="395" T="2" P="0,0,0,2,90,0,0,0" /><S L="10" H="60" X="345" Y="395" T="2" P="0,0,0,2,90,0,0,0" /></S><D><P P="0,0" Y="210" T="54" X="669" /><P P="0,0" C="3933e9" Y="164" T="60" X="125" /><P P="0,0" Y="339" T="51" X="413" /><P P="0,0" Y="395" T="62" X="105" /></D><O /></Z></C>]]
cartes[3].name = "[3] - Animjarcanin"
cartes[3].info = "700,170,450,320,100,120,105,395"

cartes[4] = {}
cartes[4].xml = [[<C><P F="2" L="1000" /><Z><S><S L="100" H="10" X="550" Y="269" T="2" P="0,0,0,1.2,0,0,0,0" /><S L="80" H="10" X="720" Y="364" T="2" P="0,0,0,1.2,0,0,0,0" /><S L="40" H="400" X="20" Y="200" T="9" P="0,0,,,,0,0,0" /><S L="40" X="980" H="400" Y="200" T="9" P="0,0,,,,0,0,0" /><S L="1000" H="40" X="500" N="" Y="380" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="400" H="30" X="240" Y="280" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="90" H="10" X="405" Y="169" T="2" P="0,0,0,1.2,0,0,0,0" /><S L="200" X="580" H="30" Y="280" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="200" H="30" X="860" Y="280" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="160" X="140" H="30" Y="180" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="240" H="30" X="380" Y="180" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="80" X="640" H="30" Y="180" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="240" H="30" X="840" Y="180" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="120" H="30" X="100" Y="80" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="80" X="320" H="30" Y="80" T="6" P="0,0,0.3,0.2,0,0,0,0" /><S L="400" H="30" X="650" Y="80" T="6" P="0,0,0.3,0.2,0,0,0,0" /></S><D><P P="0,0" Y="266" T="0" X="810" /><P P="0,0" Y="512" T="1" X="167" /><P P="0,0" Y="66" T="2" X="301" /><P P="0,0" Y="264" T="3" X="489" /><P P="0,0" Y="266" T="4" X="93" /><P P="0,0" Y="362" T="5" X="677" /><P P="0,0" Y="168" T="6" X="932" /><P P="0,0" Y="67" T="11" X="72" /><P P="0,0" Y="266" T="12" X="113" /><P P="0,0" C="57703e,e7c3d6" Y="90" T="18" X="561" /><P P="0,0" C="48230c" Y="397" T="20" X="892" /><P P="0,0" Y="379" T="32" X="527" /><P P="0,0" Y="289" T="72" X="382" /><P P="0,0" Y="177" T="78" X="929" /><P P="0,0" Y="185" T="87" X="440" /><P P="0,0" Y="265" T="110" X="201" /><P P="0,0" Y="166" T="111" X="886" /><P P="0,0" Y="268" T="83" X="604" /><P P="0,0" C="714330,390f0e" Y="360" T="103" X="394" /><P P="0,0" C="714330,1c3d11" Y="265" T="103" X="910" /><P P="0,0" C="714330,10194c" Y="165" T="103" X="142" /><P P="0,0" Y="164" T="62" X="638" /></D><O /></Z></C>]]
cartes[4].name = "[4] - Animjarcanin"
cartes[4].info = "425,345,875,250,165,150,640,165"

xRed, yRed, xGreen, yGreen, xBlue, yBlue, xBonus, yBonus = nil, nil, nil, nil, nil, nil, nil, nil

------------------------------------
-- FONCTIONS EXCLUSIVES AU MODULE --
------------------------------------

-- Permet de compter le nombre de joueurs
function countPlayers()
n = 0
for playerName in pairs(tfm.get.room.playerList) do
n = n + 1
end
return n
end

-- Permet d'obtenir le profil TheHunter d'un joueur
function getPlayer(playerName)
for k=1,#players do
if players[k].playerName == playerName then
return players[k]
end
end
end

-- Permet d'obtenir la team (table) d'un joueur
function getTeam(playerName)
player = getPlayer(playerName)
t = player.team
if t == 0 then
return red
elseif t == 1 then
return green
elseif t == 2 then
return blue
end
end

-- Permet d'obtenir les proies (table) d'un joueur
function getPrey(playerName)
team = getTeam(playerName)
if team == red then
return green
elseif team == green then
return blue
elseif team == blue then
return red
end
end

-- Évènement lorsqu'une team gagne
function teamWon(team)

if team ~= nil then
for k=1, #team do
player = getPlayer(team[k])
player.points = player.points + 5
displayPoints(team[k], player.points)
end
end

for playerName in pairs(tfm.get.room.playerList) do
if getPlayer(playerName) ~= nil then
-- JOUEUR
player = getPlayer(playerName)
-- Désactivation de la touche espace, pacte et bonus
system.bindKeyboard(playerName, 32, false, false)
system.bindKeyboard(playerName, 66, false, false)
system.bindKeyboard(playerName, 80, false, false)
-- Téléportation des joueurs sur le cadeau
tfm.exec.movePlayer(playerName, xBonus + math.random(-50.00,50.00), yBonus, false)
-- Emote applaudissements
tfm.exec.playEmote(playerName, 5)
-- On donne le fromage
tfm.exec.giveCheese(playerName)
-- On donne les points
if tfm.get.room.playerList[playerName].isDead then
player.points = player.points + 1
displayPoints(playerName, player.points)
tfm.exec.setPlayerScore(playerName, player.points, true)
else
player.points = player.points + 5
displayPoints(playerName, player.points)
tfm.exec.setPlayerScore(playerName, player.points, true)
end
end
end

-- Annonce de la victoire.
if team == red then
sendMessage(nil, trans("redwon"))
elseif team == green then
sendMessage(nil, trans("greenwon"))
elseif team == blue then
sendMessage(nil, trans("bluewon"))
end

-- Temps du jeu : 5 secondes

tfm.exec.setGameTime(5,true)

end

-- Affichage des points gagnés
function displayPoints(playerName, points)
x = xBonus
nbDix = math.floor(points/10)
points = points - (nbDix * 10)
initX = x - (15 * (nbDix - 1))
for n=1, nbDix do
tfm.exec.displayParticle(16, initX + (30 * (n - 1)), 185, 0, 0, 0, 0, playerName)
end
initX = x - (15 * (points - 1))
for n=1, points do
tfm.exec.displayParticle(15, initX + (30 * (n - 1)), 215, 0, 0, 0, 0, playerName)
end
end

-- Fonction permettant de calculer la distance entre deux joueurs
function calcDistance(x1, y1, x2, y2)
x = math.abs(x1-x2)
y = math.abs(y1-y2)
return math.sqrt((x^2)+(y^2))
end

-- Mettre le pseudo de la couleur de la team
function setDefaultName(playerName, team)
if team == nil then
team = getTeam(playerName)
end
if team == red then
tfm.exec.setNameColor(playerName, 0xCB546B)
elseif team == green then
tfm.exec.setNameColor(playerName, 0x30BA76)
elseif team == blue then
tfm.exec.setNameColor(playerName, 0x2E72CB)
end
end

-------------------------------
-- FONCTIONS LIEES AUX BONUS --
-------------------------------

function bonus(playerName, x, y)
r = math.random(0, 5)
c = tfm.get.room.playerList[playerName].community
p = getPlayer(playerName)
if r == 0 then
sendMessage(playerName, trans("invincible", tfm.get.room.playerList[playerName].community))
p.bonus = 0
bonusInvincible(playerName)
elseif r == 1 then
sendMessage(playerName, trans("explosion", tfm.get.room.playerList[playerName].community))
p.bonus = 1
elseif r == 2 then
sendMessage(playerName, trans("propulsion", tfm.get.room.playerList[playerName].community))
p.bonus = 2
elseif r == 3 then
sendMessage(playerName, trans("bigJump", tfm.get.room.playerList[playerName].community))
p.bonus = 3
elseif r == 4 then
sendMessage(playerName, trans("yellow", tfm.get.room.playerList[playerName].community))
p.bonus = 4
bonusYellow(playerName)
elseif r == 5 then
sendMessage(playerName, trans("rubberPact", tfm.get.room.playerList[playerName].community))
p.bonus = 5
end
end

function bonusInvincible(playerName)
p = getPlayer(playerName)
tfm.exec.setNameColor(playerName, 0xFFFFFF)
p.isInvincible = true
p.cdBonus = 30
end

function bonusExplosion(playerName, x, y)
p = getPlayer(playerName)
p.bonus = nil
tfm.exec.addShamanObject(24, x, y)
end

function bonusPropulsion(playerName, x, y)
p = getPlayer(playerName)
p.bonus = nil
if tfm.get.room.playerList[playerName].movingRight == true then
tfm.exec.movePlayer(playerName, 0, 0, false, 100, -10, false)
for n=1,5 do
tfm.exec.displayParticle(29, x, y, math.random(-1,1)*math.random()*math.random(), math.random(-1,1)*math.random()*math.random())
end
else
tfm.exec.movePlayer(playerName, 0, 0, false, -100, -10, false)
for n=1,5 do
tfm.exec.displayParticle(29, x, y, math.random(-1,1)*math.random()*math.random(), math.random(-1,1)*math.random()*math.random())
end
end
end

function bonusBigJump(playerName, x, y)
p = getPlayer(playerName)
p.bonus = nil
tfm.exec.movePlayer(playerName, 0, 0, false, 0, -100, false)
for n=1,5 do
tfm.exec.displayParticle(29, x, y, math.random(-1,1)*math.random()*math.random(), math.random(-1,1)*math.random()*math.random())
end
end

function bonusYellow(playerName)
p = getPlayer(playerName)
tfm.exec.setNameColor(playerName, 0xBABD2F)
p.cdBonus = 40
end

function bonusRubberPact(playerName, x, y)
p = getPlayer(playerName)
p.bonus = nil
for n=1,4 do
tfm.exec.displayParticle(31, x, y, math.random(-1,1)*math.random(), math.random(-1,1)*math.random())
end
end

--------------------------------------------
-- FONCTIONS ET ÉVENEMENTS INTERMÉDIAIRES --
--------------------------------------------

-- Évènements du clavier
function eventKeyboard(playerName, keyCode, down, x, y)
-- mort SPACE
if keyCode == 32 then
eventSpace(playerName, x, y)
-- bonus B
elseif keyCode == 66 then
eventBonus(playerName, x, y)
-- help H
elseif keyCode == 72 then
eventHelp(playerName)
-- pact P
elseif keyCode == 80 then
eventPact(playerName, x, y)
end
end

-- Event bonus
function eventBonus(playerName, x, y)
p = getPlayer(playerName)
if p.bonus ~= nil then
sendMessage(playerName, trans("bonusUsed", tfm.get.room.playerList[playerName].community))
if p.bonus == 1 then
bonusExplosion(playerName, x, y)
elseif p.bonus == 2 then
bonusPropulsion(playerName, x, y)
elseif p.bonus == 3 then
bonusBigJump(playerName, x, y)
elseif p.bonus == 5 then
bonusRubberPact(playerName, x, y)
end
elseif calcDistance(x, y, xBonus, yBonus) <= 20 then
bonus(playerName, x, y)
p.points = p.points + 1
end
end

-- Boutons help / pacte
function eventTextAreaCallback(textAreaId, playerName, eventName)
if eventName == "p" then
sendMessage(playerName, trans("pKey", tfm.get.room.playerList[playerName].community))
elseif eventName == "h" then
eventHelp(playerName)
end
end

-- Tuer un joueur
function eventSpace(hunter, x, y)
if getPlayer(hunter).cdNoKill == 0 then
prey = getPrey(hunter)
for id=1,#prey do
-- Vérification : si le chasseur peut tuer sa proie
distance = calcDistance(x, y, tfm.get.room.playerList[prey[id]].x, tfm.get.room.playerList[prey[id]].y)
if distance <= 10 and getPlayer(prey[id]).isInvincible == false then
-- On tue la proie
tfm.exec.killPlayer(prey[id])
-- On rompt les pactes
getPlayer(hunter).hasPact = false
-- On incrémente le score du chasseur
player = getPlayer(hunter)
player.points = player.points + 5
-- On publie la mort
sendMessage(hunter, trans("kill", tfm.get.room.playerList[hunter].community) .. prey[id] .. ".")
sendMessage(prey[id], trans("death", tfm.get.room.playerList[prey[id]].community) .. hunter .. ".")
end
end
end
end

-- Pacte
function eventPact(playerName, x, y)
if getPlayer(playerName).hasPact == false then
-- Création du pacte
sendMessage(playerName, trans("pact", tfm.get.room.playerList[playerName].community))
getPlayer(playerName).hasPact = true
getPlayer(playerName).cdNoKill = 20
getPlayer(playerName).points = getPlayer(playerName).points + 5
elseif getPlayer(playerName).cdNoKill == 0 then
sendMessage(playerName, trans("canKill", tfm.get.room.playerList[playerName].community))
end
for n=1,4 do
-- Animation pacte
tfm.exec.displayParticle(30, x, y, math.random(-1,1)*math.random(), math.random(-1,1)*math.random())
end
end

-- Affichage du popup d'aide
function eventHelp(playerName)
ui.addPopup(3, 0, trans("helpWindow", tfm.get.room.playerList[playerName].community), playerName, 150, 30, 500, true)
end

-- Quand un joueur meurt
function eventPlayerDied(playerName)
system.bindKeyboard(playerName, 32, false, false)
system.bindKeyboard(playerName, 66, false, false)
system.bindKeyboard(playerName, 80, false, false)
team = getTeam(playerName)
for id=1,#team do
if team[id] == playerName then
table.remove(team, id)
end
end
if #red == 0 then
teamWon(blue)
end
if #green == 0 then
teamWon(red)
end
if #blue == 0 then
teamWon(green)
end
end

-- Quand un joueur rejoint le jeu
function eventNewPlayer(playerName)
system.bindKeyboard(playerName, 72, false, true)
eventHelp(playerName)
end

-- Event loop
loop = true
function eventLoop(c, r)
if started == true then

-- à refaire
if loop == true then
t = math.ceil(r/1000)
for k=1, #players do
if players[k].cdNoKill > 0 then
msg =
sendMessage(players[k].playerName, trans("noKillDuring", tfm.get.room.playerList[players[k].playerName].community) .. players[k].cdNoKill .. trans("cooperate", tfm.get.room.playerList[players[k].playerName].community))
players[k].cdNoKill = players[k].cdNoKill - 1
if players[k].cdNoKill == 0 then
sendMessage(players[k].playerName, trans("canKill", tfm.get.room.playerList[players[k].playerName].community))
end
end
end
if t == 2 then
for playerName in pairs(tfm.get.room.playerList) do
tfm.exec.playerVictory(playerName)
end
elseif t <= 0 then
newGame()
elseif t == 10 then
teamWon()
end
loop = false
else
loop = true
end
tfm.exec.displayParticle(29, xBonus, yBonus, math.random(-1,1)*math.random(), -math.random())

-- Gestion des bonus
for playerName in pairs(tfm.get.room.playerList) do
if getPlayer(playerName) ~= nil then
p = getPlayer(playerName)
if p.cdBonus > 0 then
p.cdBonus = p.cdBonus - 1
if p.cdBonus == 0 then
p.bonus = nil
p.isInvincible = false
setDefaultName(playerName)
end
end
end
end




end
end

-------------------------------------------------------------
-- FONCTIONS PERMETTANT LE LANCEMENT D'UNE NOUVELLE PARTIE --
-------------------------------------------------------------

-- Lancement du module si un joueur rejoint
function eventNewPlayer(playerName)
if started == false and countPlayers() >= 3 then
started = true
newGame()
end
end

-- Nouvelle partie
function newGame()
if started == true then
red, green, blue, players = {}, {}, {}, {}
carte = getRandomMap()
loadMap(carte)
-- xRed, yRed, xGreen, yGreen, xBlue, yBlue, xBonus, yBonus = carte.xRed, carte.yRed, carte.xGreen, carte.yGreen, carte.xBlue, carte.yBlue, carte.xBonus, carte.yBonus
tfm.exec.newGame(carte.xml)
ui.setMapName(carte.name)
ui.addTextArea(0, '', nil, 5, 380, 790, 20, 0x111111, 0x111111, .75, true)
ui.addTextArea(1, "<font color='#009D9D'><a href='event:h'>" .. trans("h") .. " (H)</a></font>", nil, 0, 380, 55, 20, 0x000000, 0x000000, 0, true)
ui.addTextArea(2, "<font color='#009D9D'><a href='event:p'>" .. trans("p") .." (P)</a></font>", nil, 60, 380, 55, 20, 0x000000, 0x000000, 0, true)
-- Gestion des joueurs
managePlayers()
end
end

-- Gestion des joueurs
function managePlayers()

playerList = {}
for playerName in pairs(tfm.get.room.playerList) do
table.insert(playerList, playerName)
end

team = 0
id = 1
while #playerList > 0 do
k = math.random(1, #playerList)
playerName = playerList[k]
system.bindKeyboard(playerName, 32, false, true)
system.bindKeyboard(playerName, 66, false, true)
system.bindKeyboard(playerName, 72, false, true)
system.bindKeyboard(playerName, 80, false, true)
players[id] = {}
players[id].playerName = playerName
players[id].id = id
players[id].points = 0
players[id].team = team
team = setTeam(playerName, team)
players[id].hasPact = false
players[id].cdNoKill = 0
players[id].cdBonus = 0
players[id].isInvincible = false
players[id].bonus = nil
id = id + 1
table.remove(playerList, k)
end

end

-- Lecture carte
function loadMap(carte)
info = {}
for part in string.gmatch(carte.info, "[^,]+") do
table.insert(info, part)
end
xRed, yRed, xGreen, yGreen, xBlue, yBlue, xBonus, yBonus = tonumber(info[1]), tonumber(info[2]), tonumber(info[3]), tonumber(info[4]), tonumber(info[5]), tonumber(info[6]), tonumber(info[7]), tonumber(info[8])
end

-- Choix de la carte
function getRandomMap()
return cartes[math.random(1,#cartes)]
end

-- Affecter une équipe à un joueur
function setTeam(playerName, idTeam)
if idTeam == 0 then
table.insert(red, playerName)
tfm.exec.movePlayer(playerName, xRed + math.random(-50.00,50.00), yRed)
sendMessage(playerName, trans("killGreen", tfm.get.room.playerList[playerName].community))
tfm.exec.setNameColor(playerName, 0xCB546B)
return 1
elseif idTeam == 1 then
table.insert(green, playerName)
tfm.exec.movePlayer(playerName, xGreen + math.random(-50.00,50.00), yGreen)
sendMessage(playerName, trans("killBlue", tfm.get.room.playerList[playerName].community))
tfm.exec.setNameColor(playerName, 0x30BA76)
return 2
else
table.insert(blue, playerName)
tfm.exec.movePlayer(playerName, xBlue + math.random(-50.00,50.00), yBlue)
sendMessage(playerName, trans("killRed", tfm.get.room.playerList[playerName].community))
tfm.exec.setNameColor(playerName, 0x2E72CB)
return 0
end
end

-----------------------------------------
-- ARRET DU MODULE SI MANQUE DE JOUEUR --
-----------------------------------------

function eventPlayerLeft(playerName)
if started == true and countPlayers() < 3 then
ui.addPopup(4, 0, trans("err"), nil, 200, 100, 400, true)
started = false
end
end

-------------------------
-- LANCEMENT DU MODULE --
-------------------------

if countPlayers() >= 3 then
started = true
newGame()
else
ui.addPopup(4, 0, trans("err"), nil, 200, 150, 400, true)
end